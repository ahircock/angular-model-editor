<!DOCTYPE html>
<html>
<head>
    <title>Andy Page</title>
    <style>
        body { font-family: "Trebuchet MS", Helvetica, sans-serif; font-size: 16px; }
        .editBox { width: 500px; height: 500px; }
        .searchTable { border-style: solid; border: 1px black solid; border-collapse: separate; }
        .searchTableData { border-top: black 1px solid; vertical-align: text-top; }
    </style>
    <link rel="stylesheet" type="text/css" href="stylesheets/modelDetails.css">
</head>
<body id="pageBody" onload="bodyOnLoad()" onkeydown="bodyOnKeyDown(event);">
    <h1>Model Editor</h1>
    
    <div id="multiColumnSection" style="display:flex;">
        <div id="leftColumn" style="flex: 0 0 550px;">
            <div id="modelEditBand">
                <textarea id="editBox" class="editBox" initialValue=""></textarea><br>
                <button id="previewButton" type="button" onclick="previewButtonOnClick();">Preview</button>
            </div>
            <div id="modelDisplayBand" style="display:none;">
                <button id="editButton" type="button" onclick="editButtonOnClick();">Edit</button>
            </div>
            <div id="buttonBand" class="buttonBox">
                <br>
                <button id="saveButton" type="button" onclick="saveButtonOnClick();">Save</button>
                <button id="cancelButton" type="button" onclick="cancelButtonOnClick();">Cancel</button>
            </div>
        </div>
        <div id="rightColumn" style="flex-grow: 100">
            <div id="searchBox">
                <input id="searchInput" type="search" onsearch="searchInputOnSearch()">
                <button id="searchButton" type="button" onclick="searchInputOnSearch();">Search</button>
            </div>
            <div id="ruleResults">
                <table id="ruleTable" class="searchTable">
                    <tr class="searchTableHeader">
                        <th style="width:77px;"></th>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Cost</th>
                        <th style="width:20%;">Rule Name</th>
                        <th>Rule Text</th>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- OUTPUT DIALOG BOX -->
    <script src="javascripts/dialog-polyfill.js"></script>
    <dialog id="outputDialog">
        <p id="outputText"></p>
        <button id="closeOutputDialogButton" type="button" onclick="closeOutputDialogButtonOnClick();">Close</button>
    </dialog>
    <script>
        var outputDialog = document.getElementById("outputDialog");
        dialogPolyfill.registerDialog(outputDialog);
        function closeOutputDialogButtonOnClick() {
            var outputDialog = document.getElementById("outputDialog");
            outputDialog.close();
        }
        function displayOutputDialog(message) {
            document.getElementById("outputText").innerHTML = message;
            outputDialog = document.getElementById("outputDialog");
            outputDialog.showModal();
        }
    </script>

    <script src="javascripts/utils.js"></script>
    <script src="javascripts/modelAPIClient.js"></script>
    <script src="javascripts/genModelDetailsDiv.js"></script>
    <script>
        
        var globalModelObject = {};
        var globalEditModelId = "NEW";
        
        var newModelObject = {

            name: "NEW Model Name",
            traits: "trait1, trait2",
            cost: 10,
            SPD: 6,
            EV: 5,
            ARM: 0,
            HP: 5,
            specialRules: ["S0001", "S0002"],
            actions: [
                {
                    type: "MELEE",
                    name: "Melee Weapon",
                    traits: "trait1, trait2",
                    AP: 1,
                    RNG: 0,
                    HIT: 6,
                    DMG: 5,
                    ONCE: false,
                    specialRules: ["S0001"]
                },
                {
                    type: "RANGED",
                    name: "Ranged Weapon",
                    traits: "rtrait1, rtrait2",
                    AP: 1,
                    RNG: 12,
                    HIT: 7,
                    DMG: 5,
                    ONCE: false,
                    specialRules: ["S0001", "S0002"]
                },
                {
                    type: "SPECIAL",
                    name: "Special Action",
                    traits: "strait1",
                    AP: 2,
                    ONCE: true,
                    specialRules: ["S0001"]
                }
            ]
        };
        
        async function bodyOnLoad() {
            try {
                
                // if there is an ID, then load that object. Otherwise use a new object
                var editIdParm = getQueryParameterByName("editId");
                var cloneIdParm = getQueryParameterByName("cloneId");
                if ( cloneIdParm != null ) {
                    globalEditModelId = "NEW";
                    globalModelObject = await getModelById(cloneIdParm, false);
                } else if ( editIdParm != null ) {
                    globalEditModelId = editIdParm;
                    globalModelObject = await getModelById(editIdParm, false);
                } else {
                    globalEditModelId = "NEW";
                    globalModelObject = newModelObject;
                }

                // fill in the edit box with the model object (use the 'beautify" feature of JSON.stringify)
                document.getElementById("editBox").value = JSON.stringify(globalModelObject, null, 2);
                
                // load the rule table
                loadRuleTable();
                
            } catch ( err ) {
                displayOutputDialog(err.toString());
            }
        }
        
        function bodyOnKeyDown( event ) {
            if ( event.key == "Escape" ) {
                cancelButtonOnClick();
            }
        }
        
        async function saveButtonOnClick() {
            
            try {
            
                // load the value from the edit box
                globalModelObject = JSON.parse( document.getElementById("editBox").value );
                
                // call the server and add the model
                if ( globalEditModelId == "NEW" ) {
                    await addModel( globalModelObject );
                } else {
                    await updateModel( globalEditModelId, globalModelObject );
                }

                // redirect to the main page
                window.location = "./main.html?searchType=models";
                
            // if an error occurred
            } catch(err) {
                displayOutputDialog(err.toString());
            }
        }

        function cancelButtonOnClick() {
            window.location = "./main.html?searchType=models";
        }
        
        function editButtonOnClick() {
            
            // hide the modelBox and show the edit box
            document.getElementById("modelDisplayBand").style.display = "none";
            document.getElementById("modelEditBand").style.display = "block";
        }
        
        async function previewButtonOnClick() {
            
            try {
                
                // update the global object and then display it
                globalModelObject = JSON.parse( document.getElementById("editBox").value );
                await displayModelBox();
                
                // display the preview box instead of the edit box
                document.getElementById("modelDisplayBand").style.display = "block";
                document.getElementById("modelEditBand").style.display = "none";
            } catch(err) {
                displayOutputDialog(err.toString());
            }
        }
        
        function editCancelButtonOnClick() {
            document.getElementById("modelDisplayBand").style.display = "block";
            document.getElementById("modelEditBand").style.display = "none";
        }
        
        function addSpecialRuleOnClick(element) {
            window.location = "./specialRuleEditor.html";
        }
        function editSpecialRuleOnClick(element) {
            window.location = "./specialRuleEditor.html?editId=" + element.id.slice(16);
        }
        function deleteSpecialRuleOnClick(element) {
            displayOutputDialog(element.id);
        }

        function searchInputOnSearch() {
            loadRuleTable();
        }
        
        /* *** 
            This function will replace all of the special rule _id values with their full name and text
            This is only necessary so that you can display the model before it is added to the DB
        */
        async function displayModelBox() {
            
            // do a deep copy of the new object so that we can maniulate it
            var ruleEnhancedModel = JSON.parse( JSON.stringify(globalModelObject));
            
            // *** MODEL SPECIAL RULES ***
            for ( i=0; i<ruleEnhancedModel.specialRules.length; i++ ) {
                var specialRule = await getSpecialRuleById(ruleEnhancedModel.specialRules[i]);
                ruleEnhancedModel.specialRules[i] = {};
                ruleEnhancedModel.specialRules[i].ruleName = specialRule.ruleName;
                ruleEnhancedModel.specialRules[i].ruleText = specialRule.ruleText;
            }

            // *** ACTION SPECIAL RULES ***
            for ( i=0; i<ruleEnhancedModel.actions.length; i++ ) {
                for ( j=0; j<ruleEnhancedModel.actions[i].specialRules.length; j++ ) {
                    var specialRule = await getSpecialRuleById(ruleEnhancedModel.actions[i].specialRules[j]);
                    ruleEnhancedModel.actions[i].specialRules[j] = {};
                    ruleEnhancedModel.actions[i].specialRules[j].ruleName = specialRule.ruleName;
                    ruleEnhancedModel.actions[i].specialRules[j].ruleText = specialRule.ruleText;
                }
            }

            // return the enhanced model
            var modelDiv = await genModelDetailsDiv(ruleEnhancedModel);
            modelDiv.id = "modelBox";
            
            // if the modelBox already exists, removeit
            var existingModelBox = document.getElementById("modelBox");
            if ( existingModelBox != null ) {
                document.getElementById("modelDisplayBand").removeChild(existingModelBox);    
            }
            
            // insert the DIV just before the edit button
            var editButton = document.getElementById("editButton");
            document.getElementById("modelDisplayBand").insertBefore(modelDiv, editButton );
        }
        
        async function loadRuleTable() {
            
            try {
                var searchString = document.getElementById("searchInput").value;
                var response = await getSpecialRuleSearch( searchString );
            } catch (err) {
                displayError(err);
            }

            // clear the table
            var table = document.getElementById("ruleTable");
            while ( table.rows.length > 1 ) {
                table.deleteRow(1);
            }
            
            // insert a row for the NEW button
            var tr = document.createElement("tr");
            tr.className = "searchTableData";
            
            var buttonAdd = document.createElement("button");
            buttonAdd.id = "addSpecialRule";
            buttonAdd.innerHTML = "Add";
            buttonAdd.type = "button";
            buttonAdd.addEventListener("click", function( eventObject ) { addSpecialRuleOnClick(eventObject.srcElement); } );
            
            var tdButtons = document.createElement("td");
            tdButtons.appendChild(buttonAdd);
            tr.appendChild(tdButtons);                
            table.appendChild(tr);

            // insert rows into the table for each result
            for ( i=0; i < response.length; i++ ) {

                var tr = document.createElement("tr");
                tr.className = "searchTableData";

                var buttonEdit = document.createElement("button");
                buttonEdit.id = "editSpecialRule-" + response[i]._id;
                buttonEdit.innerHTML = "Edit";
                buttonEdit.type = "button";
                buttonEdit.addEventListener("click", function( eventObject ) { editSpecialRuleOnClick(eventObject.srcElement); } );
                
                var buttonDelete = document.createElement("button");
                buttonDelete.id = "deleteSpecialRule-" + response[i]._id;
                buttonDelete.innerHTML = "Del";
                buttonDelete.type = "button";
                buttonDelete.addEventListener("click", function( eventObject ) { deleteSpecialRuleOnClick(eventObject.srcElement); } );
                
                var tdButtons = document.createElement("td");
                tdButtons.appendChild(buttonEdit);
                tdButtons.appendChild(buttonDelete);

                var tdType = document.createElement("td");
                tdType.id = "tdRuleType-" + response[i]._id;
                tdType.innerHTML = response[i].ruleType;

                var tdCost = document.createElement("td");
                tdCost.id = "tdRuleCost-" + response[i]._id;
                tdCost.innerHTML = response[i].ruleCost;

                var tdName = document.createElement("td");
                tdName.id = "tdRuleName-" + response[i]._id;
                if ( typeof(response[i].ruleAP) != "undefined" ) {
                    tdName.innerHTML = "[" + response[i].ruleAP + "] " + response[i].ruleName;
                } else {
                    tdName.innerHTML = response[i].ruleName;    
                }
                

                var tdText = document.createElement("td");
                tdText.id = "tdRuleText-" + response[i]._id;
                tdText.innerHTML = response[i].ruleText;

                var tdId = document.createElement("td");
                tdId.id = "tdRuleId-" + response[i]._id;
                tdId.innerHTML = response[i]._id;

                // add all of the table data cells
                tr.appendChild(tdButtons);
                tr.appendChild(tdId);
                tr.appendChild(tdType);
                tr.appendChild(tdCost);
                tr.appendChild(tdName);
                tr.appendChild(tdText);
                table.appendChild(tr);
            }
        }

    </script>
</body>
</html>